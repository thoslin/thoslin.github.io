<html>
  <head>
    
      <title>Tom Lin's thoughts and writings</title>
    
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <script type="text/javascript">
      WebFontConfig = {
        google: { families: [ 'Droid+Sans::latin' ] }
      };
      (function() {
        var wf = document.createElement('script');
        wf.src = ('https:' == document.location.protocol ? 'https' : 'http') +
          '://ajax.googleapis.com/ajax/libs/webfont/1/webfont.js';
        wf.type = 'text/javascript';
        wf.async = 'true';
        var s = document.getElementsByTagName('script')[0];
        s.parentNode.insertBefore(wf, s);
      })();
    </script>
    <link rel="stylesheet" type="text/css" href="/stylesheets/screen.css">
  </head>
  <body>
    <header id="spine">
    <h1 id="hey">
        <a href="/">Hi,<br/> I'm Tom.</a>
    </h1>
    <p class="description">
    I'm a Python web developer living in Shanghai. This is my personal website and blog.
</p>
    <div id="profiles">
    <a href="/">Blog</a>
    <span>&nbsp;&middot;&nbsp;</span>
    <a target="_blank" href="http://github.com/thoslin">Github</a>
    <span>&nbsp;&middot;&nbsp;</span>
    <a target="_blank" href="http://twitter.com/thoslin">Twitter</a>
</div>
    <div id="recent">
    <h5 class="heading">Recent <a href="/archive/" id="full-archive">(Full archive &rarr;)</a></h5>
    <ol>
        
        <li>
          <a href="/microservice-health-check-in-kubernetes/">Microservice health check in Kubernetes</a>
        </li>
        
        <li>
          <a href="/build-a-simple-protocol-over-tcp/">Build a simple protocol over TCP</a>
        </li>
        
        <li>
          <a href="/cassandra-a-journey-of-upgrade/">Cassandra: A Journey of Upgrade</a>
        </li>
        
        <li>
          <a href="/ramble-on-java-and-session/">Ramble on Java &amp; Session</a>
        </li>
        
        <li>
          <a href="/cassandra-create-a-cluster-on-your-local-machine/">Cassandra: Create a cluster on your local machine</a>
        </li>
        
    </ol>
</div>
    <h4>Site designed by <a target="_blank" href="https://github.com/orourkedesign">@orourkedesign</a>.
</header>
    <section id="content">
      
  
  
  <article>
  <div class="meta">
    <time>23 Jan 2018</time>
  </div>
  <h1>Microservice health check in Kubernetes</h1>
  
  <h1>TL;DR</h1>

<p>Service should provide a standard endpoint for the purpose of health check and monitoring. The specification for the endpoint should conform to the requirements as elaborated in section <a href="#Requirements">Requirements</a>.</p>

<h1>Background</h1>

<h2>what is health check</h2>

<p>A health check detects the healthy status of a service, reporting whether the service is able to handle requests or whether the service is in a bad state and should be restarted.</p>

<h2>Why health check is needed</h2>

<h3>High availability</h3>

<p>There are many cases when a service is started/restarted</p>

<ul>
<li>instance/pod restart</li>
<li>service/deployment up scaling</li>
<li>rolling update</li>
</ul>


<p>Under these circumstances, if a request is forwared to a service that is still in the middle of its starting/restarting process, it would probably fail. So we need to make sure a service is healthy to accept requests before adding it to the load balancer(kubernetes service), such that we could reduce the service down time and achieve high availability.</p>

<h3>Service stability</h3>

<p>Service running for a long period of time may fall into a bad state, in which service is unable to handle requests properly. In this case, service needs to be prohibited from receiving requests, until it is recovered either via restart or manual resurrection. Thus our service in all is stable.</p>

<h3>Monitoring</h3>

<p>A big part of the DevOps responsibilities is to monitor and maintain the health of running services. If a service goes down, appropriate actions should be undertaken to bring the service back to life. Health check informs the DevOps whether the service is malfunctioning.</p>

<h2>Clients of health checks</h2>

<ul>
<li>Load balancer (Kubernetes service)</li>
<li>Monitoring service (Prometheus probe)</li>
<li>Pods (Readiness/Liveness probe)</li>
</ul>


<h2>Downsides of health check</h2>

<p>As health check is done periodically, not in a real time manner, there still could be time gap before the unhealthy state is known to the clients. To mitigate the effect of this situation, a reasonable checking period should be set.</p>

<h1>Requirements</h1>

<h2>What should be checked</h2>

<p>As the definition of healthy may vary from service to service, depending on the service application logics, there could be many levels of healthy:</p>

<ul>
<li>the service is up</li>
<li>the service is up and the infrastructure service used by the service is healthy</li>
<li>the service is up, the infrastructure service used by the service is healthy, the dependent microservice is healthy</li>
<li>the service is up, the infrastructure service used by the service is healthy, the dependent microservice is healthy, smoke tests are passed</li>
</ul>


<p>Each service may define its own criteria, however the result of these checks should be certain, ie, the service is either healthy or not healthy, there should be no middle state.</p>

<h2>How to expose health check to clients</h2>

<ul>
<li>The service should implement the health check in a RESTful API manner.</li>
<li>The endpoint is unified as &ldquo;/health&rdquo;</li>
</ul>


<h2>How health check respond to clients</h2>

<h3>Status code</h3>

<ul>
<li>200 OK for healthy</li>
<li>503 Service Unavailable for unhealthy</li>
</ul>


<h3>Response body</h3>

<p>Response body can be empty, however attaching additional information of what is checked and the result of the check is preferred</p>

<h2>Security/Access control</h2>

<p>The health check should be private and limited to internal access, however if it is open to public access:</p>

<ul>
<li>For unauthenticated access, service should provide a basic health info, returning a UP/DOWN status</li>
<li>For authenticated access, service may provide more detail health info</li>
</ul>


<h1>Implementation</h1>

<h2>Examples</h2>

<p><strong>Service OK</strong></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl -XGET http://127.0.0.1:9000/health
</span><span class='line'>HTTP/1.1 200 OK
</span><span class='line'>Content-Type: application/json; charset=utf-8
</span><span class='line'> 
</span><span class='line'>{
</span><span class='line'>    "status": "UP"
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p><strong>Service Unavailable</strong></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl -XGET http://127.0.0.1:9000/health
</span><span class='line'>HTTP/1.1 503 Service Unavailable
</span><span class='line'>Content-Type: application/json; charset=utf-8
</span><span class='line'> 
</span><span class='line'>{
</span><span class='line'>    "status": "Down"
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p><strong>Authenticated access</strong></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl -XGET http://127.0.0.1:9000/health -H 'Authorization: Basic ZnNfbm9ybWFsOkBDZ0JkSjZOKz9TbmQhRytIJEI3'
</span><span class='line'>HTTP/1.1 200 OK
</span><span class='line'>Content-Type: application/json; charset=utf-8
</span><span class='line'> 
</span><span class='line'>{ 
</span><span class='line'>  "status":"UP",
</span><span class='line'>  "fooService":{ 
</span><span class='line'>    "status":"UP",
</span><span class='line'>    "description":"Foo service"
</span><span class='line'>  },
</span><span class='line'>  "mysql":{ 
</span><span class='line'>    "status":"UP",
</span><span class='line'>    "description":"MySQL Database",
</span><span class='line'>    "hello":1
</span><span class='line'>  }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<h2>Libraries</h2>

<h3>Java</h3>

<p><a href="https://docs.spring.io/spring-boot/docs/current/reference/htmlsingle/#production-ready-health">Spring Boot Actuator</a></p>

<h3>Go</h3>

<p>N/A</p>

<h1>Client Integration</h1>

<h2>Kubernetes integration</h2>

<p>Please refer to <a href="https://kubernetes.io/docs/tasks/configure-pod-container/configure-liveness-readiness-probes/">https://kubernetes.io/docs/tasks/configure-pod-container/configure-liveness-readiness-probes/</a></p>

<p>Readiness and liveness probes can be used in parallel for the same container. Using both can ensure that traffic does not reach a container that is not ready for it, and that containers are restarted when they fail.</p>

<h3>Readiness Probe</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>readinessProbe: # check if service in a healthy state, will remove pod from service/loadbalancer if probe failed
</span><span class='line'>    httpGet:
</span><span class='line'>        path: /health
</span><span class='line'>        port: 9000
</span><span class='line'>    initialDelaySeconds: 10 # start checking after 10s after pod starts. should set to a minimal value such that service able to receive requests as soon as it is ready
</span><span class='line'>    periodSeconds: 10 # check health check api every 10 seconds
</span><span class='line'>    timeoutSeconds: 3 # if response time is logger than 3 seconds, we consider the check as failed
</span><span class='line'>    failureThreshold: 3  # if check fails for 3 times in a row, we consider the pod is in a bad state, pod will be restarted
</span><span class='line'>    successThreshold: 1 # if check succeeds for once, we consider the pod is back to normal</span></code></pre></td></tr></table></div></figure>


<h3>Liveness Probe</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>livenessProbe: # check if pod is in a bad state, will restart pod if probe failed
</span><span class='line'>    httpGet:
</span><span class='line'>        path: /health
</span><span class='line'>        port: 9000
</span><span class='line'>    initialDelaySeconds: 180 # start checking after 180s after pod starts, should be logger than service start time. Some service takes minutes to start, so we set a big value here.
</span><span class='line'>    periodSeconds: 10 # check health check api every 10 seconds
</span><span class='line'>    timeoutSeconds: 3 # if response time is logger than 3 seconds, we consider the check as failed
</span><span class='line'>    failureThreshold: 3 # if check fails for 3 times in a row, we consider the pod is in a bad state, pod will be restarted
</span><span class='line'>    successThreshold: 1 # if check succeeds for once, we consider the pod is back to normal</span></code></pre></td></tr></table></div></figure>


<h2>Prometheus integration</h2>

<p>Prometheus keeps polling health API constantly and store the result in its time series database. If health check metrics match a predefined alert rule, a alert will be triggered.</p>

<h3>Scrape config</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>job_name: 'health-check'
</span><span class='line'>  metrics_path: /probe
</span><span class='line'>  params:
</span><span class='line'>    module: [http_2xx]  # Look for a HTTP 200 response.
</span><span class='line'>  kubernetes_sd_configs:
</span><span class='line'>  - role: service
</span><span class='line'> 
</span><span class='line'>  relabel_configs:
</span><span class='line'>    - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_healthcheck]
</span><span class='line'>      regex: true
</span><span class='line'>      action: keep
</span><span class='line'>    - source_labels: [__meta_kubernetes_service_name]
</span><span class='line'>      target_label: service
</span><span class='line'>    - source_labels: [__address__]
</span><span class='line'>      regex: (.*)(:80)?
</span><span class='line'>      target_label: __param_target
</span><span class='line'>      replacement: ${1}/health
</span><span class='line'>    - source_labels: [__param_target]
</span><span class='line'>      regex: (.*)
</span><span class='line'>      target_label: instance
</span><span class='line'>      replacement: ${1}
</span><span class='line'>    - source_labels: []
</span><span class='line'>      regex: .*
</span><span class='line'>      target_label: __address__
</span><span class='line'>      replacement: blackbox-exporter-service:9115  # Blackbox exporter.</span></code></pre></td></tr></table></div></figure>


<h3>Service annotation</h3>

<p>Add <em>prometheus.io/healthcheck</em> annotation to Kubernetes service so that they could be discovered by the health check job.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>apiVersion: v1
</span><span class='line'>kind: Service
</span><span class='line'>metadata:
</span><span class='line'>  annotations:
</span><span class='line'>    prometheus.io/healthcheck: "true"
</span><span class='line'>  name: foo-service
</span><span class='line'>  namespace: foo
</span><span class='line'>  labels:
</span><span class='line'>    app: foo-service
</span><span class='line'>spec:
</span><span class='line'>  ports:
</span><span class='line'>  - port: 80
</span><span class='line'>    targetPort: 8000
</span><span class='line'>    protocol: TCP
</span><span class='line'>  selector:
</span><span class='line'>    app: foo</span></code></pre></td></tr></table></div></figure>


<h3>Blackbox exporter config</h3>

<p>Config a <em>http_2xx</em> module to scrape health api</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>modules:
</span><span class='line'>  http_2xx:
</span><span class='line'>    prober: http
</span><span class='line'>    timeout: 5s
</span><span class='line'>    http:
</span><span class='line'>      valid_status_codes: []  # Defaults to 2xx
</span><span class='line'>      method: GET
</span><span class='line'>      headers: {}
</span><span class='line'>      no_follow_redirects: false
</span><span class='line'>      fail_if_ssl: false
</span><span class='line'>      fail_if_not_ssl: false
</span><span class='line'>      fail_if_matches_regexp: []
</span><span class='line'>      fail_if_not_matches_regexp: []</span></code></pre></td></tr></table></div></figure>


</article>
  <div class="sep">&nbsp;</div>

  
  
  <article>
  <div class="meta">
    <time>24 Sep 2015</time>
  </div>
  <h1>Build a simple protocol over TCP</h1>
  
  <p>Disclaimer: I am not an expert of TCP or designing protocols, this post is just about my learning experience of building a protocols over TCP :)</p>

<h4>A rookie mistake</h4>

<p>When I was playing with sockets. A rookie mistake I made is assuming that each message send implies a message receive, like the following example:</p>

<p>server.py</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">import</span> <span class="nn">socket</span>
</span><span class='line'>
</span><span class='line'><span class="n">sock</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
</span><span class='line'><span class="n">sock</span><span class="o">.</span><span class="n">bind</span><span class="p">((</span><span class="n">socket</span><span class="o">.</span><span class="n">gethostname</span><span class="p">(),</span> <span class="mi">2333</span><span class="p">))</span>
</span><span class='line'><span class="n">sock</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span class='line'><span class="n">connection</span><span class="p">,</span> <span class="n">address</span> <span class="o">=</span> <span class="n">sock</span><span class="o">.</span><span class="n">accept</span><span class="p">()</span>
</span><span class='line'><span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
</span><span class='line'>    <span class="n">data</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
</span><span class='line'>    <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span><span class="p">:</span>
</span><span class='line'>        <span class="k">break</span>
</span><span class='line'>    <span class="k">print</span> <span class="s">&quot;Received: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">data</span>
</span></code></pre></td></tr></table></div></figure>


<p>client.py</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">import</span> <span class="nn">socket</span>
</span><span class='line'>
</span><span class='line'><span class="n">socket_address</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">gethostname</span><span class="p">(),</span> <span class="mi">2333</span>
</span><span class='line'><span class="n">connection</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">create_connection</span><span class="p">(</span><span class="n">socket_address</span><span class="p">)</span>
</span><span class='line'><span class="n">connection</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s">&quot;Hello there!&quot;</span><span class="p">)</span>
</span><span class='line'><span class="n">connection</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s">&quot;Bye bye!&quot;</span><span class="p">)</span>
</span><span class='line'><span class="n">connection</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure>


<p>Run the client. I got the following output:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="n">Receive</span><span class="p">:</span> <span class="n">Hello</span> <span class="n">there</span><span class="err">!</span><span class="n">Bye</span> <span class="n">bye</span><span class="err">!</span>
</span></code></pre></td></tr></table></div></figure>


<p>.</p>

<p>So two sends result in one receive, not two receives as expected. Hah. This is a misunderstanding of how TCP works.</p>

<p>TCP is a stream oriented protocol, not a packet/message oriented protocol like UDP. I&rsquo;d like to use this analogy: TCP is like making a phone call, a connection must be established before both end is able to talk, and when you talk, data stream flows on the connection. While UDP is like you&rsquo;re sending a text message.</p>

<h4>The boundary</h4>

<p>However this rookie mistake got me thinking, when we&rsquo;re building an application on top of TCP socket, for example, a chatting application, how do we know where each message ends since they are a stream of data? Where&rsquo;s the boundary of two messages? There must be something up on the application level.</p>

<h4>1. Delimiter</h4>

<p>Back to the phone call analogy, let&rsquo;s say foo is reading a poem to bar over the phone, how does bar know when foo finishes a line? how does bar know if foo finishes the whole poem? Does the wired connection do that for you? NO. But what we know from common sense is that, there&rsquo;s a pause when you finish a line, and maybe a longer pause when you finish the poem. Similarly, maybe we can put a pause in the end of each message? Just like <a href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec2.html#sec2.2">\r\n</a> in HTTP headers.</p>

<p>Here is an improved version of the previous code using \r\n as the delimiter:</p>

<p>server.py</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">import</span> <span class="nn">socket</span>
</span><span class='line'>
</span><span class='line'><span class="n">sock</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
</span><span class='line'><span class="n">sock</span><span class="o">.</span><span class="n">bind</span><span class="p">((</span><span class="n">socket</span><span class="o">.</span><span class="n">gethostname</span><span class="p">(),</span> <span class="mi">2333</span><span class="p">))</span>
</span><span class='line'><span class="n">sock</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span class='line'><span class="n">connection</span><span class="p">,</span> <span class="n">address</span> <span class="o">=</span> <span class="n">sock</span><span class="o">.</span><span class="n">accept</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'><span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
</span><span class='line'>    <span class="n">data</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
</span><span class='line'>    <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span><span class="p">:</span>
</span><span class='line'>        <span class="k">break</span>
</span><span class='line'>    <span class="k">else</span><span class="p">:</span>
</span><span class='line'>        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">):</span>
</span><span class='line'>            <span class="k">if</span> <span class="n">line</span><span class="p">:</span>
</span><span class='line'>                <span class="k">print</span> <span class="s">&quot;Received: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">line</span>
</span></code></pre></td></tr></table></div></figure>


<p>client.py</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">import</span> <span class="nn">socket</span>
</span><span class='line'>
</span><span class='line'><span class="n">socket_address</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">gethostname</span><span class="p">(),</span> <span class="mi">2333</span>
</span><span class='line'><span class="n">connection</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">create_connection</span><span class="p">(</span><span class="n">socket_address</span><span class="p">)</span>
</span><span class='line'><span class="n">connection</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s">&quot;Hello there!</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">)</span>
</span><span class='line'><span class="n">connection</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s">&quot;Bye bye!</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">)</span>
</span><span class='line'><span class="n">connection</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now we got the separate output:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="n">Received</span><span class="p">:</span> <span class="n">Hello</span> <span class="n">there</span><span class="err">!</span>
</span><span class='line'><span class="n">Received</span><span class="p">:</span> <span class="n">Bye</span> <span class="n">bye</span><span class="err">!</span>
</span></code></pre></td></tr></table></div></figure>


<p>The downside of this approach is that, when dealing with a message that is longer than 1024, you just get part of the message. We might need a buffer to receive message until we get a delimiter.</p>

<h4>2. Fix length or Prefix length</h4>

<p>What if messages are all in fix length? Short message can be filled with empty string, something like:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="n">connection</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s">&quot;Hello there!&quot;</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">140</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>


<p>So server just need to keep reading fix length of bytes from socket. This works. However there is still a hard limit on the length of the message.</p>

<p>What if we tell the server the length of each message beforehand? We can do that by prefixing the message with the length of it. Yes! Just like the &ldquo;Content-Length&rdquo; header in HTTP.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="n">make_message</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">))</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="n">x</span>
</span><span class='line'><span class="n">connection</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">make_message</span><span class="p">(</span><span class="s">&quot;Hello there!&quot;</span><span class="p">))</span>
</span><span class='line'><span class="n">connection</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">make_message</span><span class="p">(</span><span class="s">&quot;Bye bye!&quot;</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>


<p>Here we prefix each message 4 bytes string indicating the length of the message. And server will first read the 4 bytes to get the length, then read as much bytes as that. The recvall function is to get the certain length of data, otherwise with simply recv, there&rsquo;s a chance we get just part of the transmitted data. Although in local machine the chance is low.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="n">connection</span><span class="p">,</span> <span class="n">address</span> <span class="o">=</span> <span class="n">sock</span><span class="o">.</span><span class="n">accept</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">recvall</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">remains</span><span class="p">):</span>
</span><span class='line'>    <span class="n">buf</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
</span><span class='line'>    <span class="k">while</span> <span class="n">remains</span><span class="p">:</span>
</span><span class='line'>        <span class="n">data</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="n">remains</span><span class="p">)</span>
</span><span class='line'>        <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span><span class="p">:</span>
</span><span class='line'>            <span class="k">break</span>
</span><span class='line'>        <span class="n">buf</span> <span class="o">+=</span> <span class="n">data</span>
</span><span class='line'>        <span class="n">remains</span> <span class="o">-=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">buf</span>
</span><span class='line'>
</span><span class='line'><span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
</span><span class='line'>    <span class="n">data</span> <span class="o">=</span> <span class="n">recvall</span><span class="p">(</span><span class="n">connection</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
</span><span class='line'>    <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span><span class="p">:</span>
</span><span class='line'>        <span class="k">break</span>
</span><span class='line'>    <span class="n">length</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span><span class='line'>    <span class="n">message</span> <span class="o">=</span> <span class="n">recvall</span><span class="p">(</span><span class="n">connection</span><span class="p">,</span> <span class="n">length</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">print</span> <span class="s">&quot;Received: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">message</span>
</span></code></pre></td></tr></table></div></figure>


<p>At this point, we have something like a protocol over the TCP layer, which is able to achieve the original goal.</p>

<h4>Native protocol of Cassandra</h4>

<p>Now that we have a protocol of our own, although simple and naive, I&rsquo;d like to take a look at some serious protocol that built on TCP. Since I&rsquo;ve been working with Cassandra a lot lately. I might as well just check their protocol.</p>

<p><a href="https://git-wip-us.apache.org/repos/asf?p=cassandra.git;a=blob_plain;f=doc/native_protocol.spec;hb=refs/heads/cassandra-1.2">CQL</a> is the protocol of Cassandra, which is built on TCP:</p>

<p><quote>
  The CQL binary protocol is a frame based protocol. Frames are defined as:</p>

<pre><code>  0         8        16        24        32
  +---------+---------+---------+---------+
  | version |  flags  | stream  | opcode  |
  +---------+---------+---------+---------+
  |                length                 |
  +---------+---------+---------+---------+
  |                                       |
  .            ...  body ...              .
  .                                       .
  .                                       .
  +----------------------------------------
</code></pre>

<p></quote></p>

<p>Frames can be regarded as what we called messages in previous examples. Except the first 32 bits, the length and body part is just what we used. So our approach looks practical.</p>

<p>So that&rsquo;s it, there must be more technical details regarding building a full-fledged protocol, but some fundamental things should work the same.</p>

</article>
  <div class="sep">&nbsp;</div>

  
  
  <article>
  <div class="meta">
    <time>18 Sep 2015</time>
  </div>
  <h1>Cassandra: A Journey of Upgrade</h1>
  
  <p>For the past few couple months, a huge burden on my shoulder had been upgrading our Cassandra cluster from 1.2.6 to 2.1. I&rsquo;ve been investing a lot of working hours to figure out the solution. Now that it has been done, I feel it is worthwhile to write down the whole experience.</p>

<h3>Why Upgrade?</h3>

<p>Actually the imperative reason is that we need transaction support in one of our services. And Cassandra 2.0 introduced a new feature called light-weight transaction, although it is light-weight, it somehow can fix our issue.</p>

<p>Besides that, there are also a couple of new features we can benefit from the upgrade:</p>

<ul>
<li>Improved native transport protocol. We&rsquo;re quite interested in the more stream requests over one connection. This is introduced in 2.1.</li>
<li>Automatically paging support. We have queries for a large number of rows, this at a big chance will cause RPC timeout. Our workaround is to implements our own paging mechanism.</li>
<li>Better counter. It is well known that Cassandra&rsquo;s distributed counter is buggy. They improve it in 2.1</li>
</ul>


<h3>Infrastructure</h3>

<ul>
<li>10 nodes on production. 3 nodes on other stacks.</li>
<li>Replication factor: 3</li>
<li>Replication strategy: Simple strategy</li>
<li>Consistency level: CL.ONE for both read and write.</li>
</ul>


<h3>Upgrade Path</h3>

<h4>Driver upgrade</h4>

<p>We&rsquo;re using a fairly old driver Cassandra called Pycassa, which is no longer maintained. And it is based on thrift protocol, which is deprecated/ditched in the version 3, so all the new and good stuff on the native protocol has nothing to do with Pycassa. Very naturally we switched to the recommended/official driver maintained by the Datastax.</p>

<p>Internally we don&rsquo;t have a layer for Cassandra, so refactoring is a lot of pain. We have to replace all the code usages of Pycassa among all services, and carefully update all unit tests.</p>

<p>We also bumped into some issues when deploying with the new driver:</p>

<ul>
<li><a href="https://datastax-oss.atlassian.net/browse/PYTHON-239">High CPU utilization when using asyncore event loop</a>. By now, this is not been fixed yet, so avoid using asycore, instead use gevent/libev.</li>
<li><a href="https://datastax-oss.atlassian.net/browse/PYTHON-364">Reconnect not initiated when all nodes are down</a></li>
<li><a href="https://datastax-oss.atlassian.net/browse/PYTHON-325">ConstantReconnectionPolicy does not work with max_attempts=None</a></li>
<li><a href="https://datastax-oss.atlassian.net/browse/PYTHON-237">Can&rsquo;t detect gevent monkey patch when using with uwsgi &mdash;gevent-monkey-patch option</a>. If you are monkey patch in uwsgi, use -gevent-early-monkey option.</li>
</ul>


<p>The driver upgrade is not as smooth as I thought. A lot of back and forth happened and it took us almost two month or so to ship the upgrade.</p>

<h4>No rolling upgrade?</h4>

<p>Rolling upgrade should be a default option for a cluster upgrade. But unfortunately it is not supported between major versions of Cassandra. As it is documented <a href="https://github.com/apache/cassandra/blob/trunk/NEWS.txt">here</a>. We thought about workarounds. Like building a new Cluster and syncing data between two clusters. But building a new cluster is not our option due to some &ldquo;policy&rdquo;, so we decided that we can tolerate some downtime, and that also means we will update each Cassandra instance in place.</p>

<h4>Data backup and restore</h4>

<p>It&rsquo;s important to have a backup of the data. In case something goes wrong, we can go back to the save point. When doing data backup, we demand that all services that access Cassandra should be stopped and keep data untouched during the process.</p>

<p>Below is a typical structure of one of  our Cassandra nodes:</p>

<p>/mnt/cassandra/</p>

<p>── commitlog_directory</p>

<p>── data_file_directories</p>

<p>&ldquo;data_file_directories&rdquo; is where Cassandra data files live, our goal is to backup this directory. We&rsquo;ll do a &lsquo;<a href="http://docs.datastax.com/en/cassandra/2.0/cassandra/tools/toolsDrain.html">nodetool drain</a>&rsquo; on the node, which will flush all memtables to data files. After that We&rsquo;ll pack data_file_directories into one tarball and upload it to the cloud(to prevent disk failure of node). So we&rsquo;ll have two copies of data.</p>

<p>Procedure:</p>

<ul>
<li>Drain the node</li>
<li>Clear snapshots</li>
<li>Shut down the node</li>
<li>Pack data files into a tarball.</li>
<li>Upload the tarball to swift</li>
</ul>


<p>If something goes wrong and we want to abort the upgrade and go back to the old version. We simply retrieve the old data and unpack it to the Cassandra data file directory.</p>

<p>The backup and restore procedure are automated by Ansible scripts.</p>

<h4>Upgrade</h4>

<p>Upgrade directly from current version 1.2.6 to 2.1 is not possible. Since pre-2.0 SSTables are not supported by 2.1. A direct upgrade to 2.1, Cassandra would fail to start and following error would be raised:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>java.lang.RuntimeException: Incompatible SSTable found. Current version ka is unable to read file: /var/lib/cassandra/data/system/schema_keyspaces/system-schema_keyspaces-ic-1. Please run upgradesstables.
</span><span class='line'>        at org.apache.cassandra.db.ColumnFamilyStore.createColumnFamilyStore(ColumnFamilyStore.java:443) ~[apache-cassandra-2.1.1.jar:2.1.1]
</span><span class='line'>        at org.apache.cassandra.db.ColumnFamilyStore.createColumnFamilyStore(ColumnFamilyStore.java:420) ~[apache-cassandra-2.1.1.jar:2.1.1]
</span><span class='line'>        at org.apache.cassandra.db.Keyspace.initCf(Keyspace.java:327) ~[apache-cassandra-2.1.1.jar:2.1.1]
</span><span class='line'>        at org.apache.cassandra.db.Keyspace.&lt;init&gt;(Keyspace.java:280) ~[apache-cassandra-2.1.1.jar:2.1.1]
</span><span class='line'>        at org.apache.cassandra.db.Keyspace.open(Keyspace.java:122) ~[apache-cassandra-2.1.1.jar:2.1.1]
</span><span class='line'>        at org.apache.cassandra.db.Keyspace.open(Keyspace.java:99) ~[apache-cassandra-2.1.1.jar:2.1.1]
</span><span class='line'>        at org.apache.cassandra.db.SystemKeyspace.checkHealth(SystemKeyspace.java:558) ~[apache-cassandra-2.1.1.jar:2.1.1]
</span><span class='line'>        at org.apache.cassandra.service.CassandraDaemon.setup(CassandraDaemon.java:214) [apache-cassandra-2.1.1.jar:2.1.1]
</span><span class='line'>        at org.apache.cassandra.service.CassandraDaemon.activate(CassandraDaemon.java:443) [apache-cassandra-2.1.1.jar:2.1.1]
</span><span class='line'>        at org.apache.cassandra.service.CassandraDaemon.main(CassandraDaemon.java:532) [apache-cassandra-2.1.1.jar:2.1.1]</span></code></pre></td></tr></table></div></figure>


<p>So we upgraded to 2.0.0 and run upgradesstables command to upgrade SSTables. After that, we then upgrade from 2.0.0 to 2.1.</p>

<p>Cassandra has an internal <a href="http://www.bajb.net/2013/03/cassandra-sstable-format-version-numbers/">version for SSTables</a>. During the upgrade, sstable version will be bumping from:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>ic (1.2.6) --&gt; ja (2.0.0) --&gt; ka(2.1.3)</span></code></pre></td></tr></table></div></figure>


<p>Procedure:</p>

<ul>
<li>Install Cassandra 2.0.0. Before starting, set num_tokens to 1. The new version uses virtual nodes by default.</li>
<li>Upgrade SSTables</li>
<li>Drain and stop the node</li>
<li>Remove commit logs</li>
<li>Install Cassandra 2.1.3</li>
<li>Upgrade SSTables (Not necessary)</li>
<li>Bring back all services</li>
</ul>


<p>The procedure looks simple and clear. While we had couple issue when doing test upgrade:</p>

<ul>
<li>After upgrade from 1.2.6 to 2.0.0, Cassandra cannot start due to out of memory. It turns out when Cassandra starts, it would read the key cache. OutOfMemory when reading key cache seems to be a <a href="http://cassandra-user-incubator-apache-org.3065146.n2.nabble.com/OOM-while-reading-key-cache-td7591267.html">known issue</a>. The solution is to <a href="http://mail-archives.apache.org/mod_mbox/cassandra-user/201307.mbox/%3C7B902431-9666-4D21-9324-8632BB6358F8@thelastpickle.com%3E">clean up caches</a> before starting up.</li>
<li>During the upgrade to 2.1, drain failed. It is a <a href="https://issues.apache.org/jira/browse/CASSANDRA-6374">bug</a> and said to be fixed in 2.0.3. So we upgrade to 2.0.3 instead.</li>
</ul>


<h4>Data consistency</h4>

<p>How to ensure data are not corrupted during the upgrade? I think this should be guaranteed by Cassandra. However when doing upgrade testing, we have a script to dump all Cassandra data before and after the upgrade to ensure data are not touched. This step is taken away when we&rsquo;re doing actual upgrade.</p>

</article>
  <div class="sep">&nbsp;</div>

<div id="full-archive">
    <a href="/archive/">View the full archive &rarr;</a>
</div>
    </section>
    <script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-42896888-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>
  </body>
</html>