<html>
  <head>
    
      <title>Tom Lin's thoughts and writings</title>
    
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <script type="text/javascript">
      WebFontConfig = {
        google: { families: [ 'Droid+Sans::latin' ] }
      };
      (function() {
        var wf = document.createElement('script');
        wf.src = ('https:' == document.location.protocol ? 'https' : 'http') +
          '://ajax.googleapis.com/ajax/libs/webfont/1/webfont.js';
        wf.type = 'text/javascript';
        wf.async = 'true';
        var s = document.getElementsByTagName('script')[0];
        s.parentNode.insertBefore(wf, s);
      })();
    </script>
    <link rel="stylesheet" type="text/css" href="/stylesheets/screen.css">
  </head>
  <body>
    <header id="spine">
    <h1 id="hey">
        <a href="/">Hi,<br/> I'm Tom.</a>
    </h1>
    <p class="description">
    I'm a Python web developer living in Shanghai. This is my personal website and blog.
</p>
    <div id="profiles">
    <a href="/">Blog</a>
    <span>&nbsp;&middot;&nbsp;</span>
    <a target="_blank" href="http://github.com/thoslin">Github</a>
    <span>&nbsp;&middot;&nbsp;</span>
    <a target="_blank" href="http://twitter.com/thoslin">Twitter</a>
</div>
    <div id="recent">
    <h5 class="heading">Recent <a href="/archive/" id="full-archive">(Full archive &rarr;)</a></h5>
    <ol>
        
        <li>
          <a href="/ramble-on-java-and-session/">Ramble on Java &amp; Session</a>
        </li>
        
        <li>
          <a href="/cassandra-create-a-cluster-on-your-local-machine/">Cassandra: Create a cluster on your local machine</a>
        </li>
        
        <li>
          <a href="/simple-guide-to-install-statsd-and-graphite/">Simple Guide to Install StatsD and Graphite</a>
        </li>
        
        <li>
          <a href="/impostor-syndrome/">Impostor syndrome</a>
        </li>
        
        <li>
          <a href="/async-download-with-celery/">Async Download with Celery</a>
        </li>
        
    </ol>
</div>
    <h4>Site designed by <a target="_blank" href="https://github.com/orourkedesign">@orourkedesign</a>.
</header>
    <section id="content">
      
  
  
  <article>
  <div class="meta">
    <time>08 Sep 2015</time>
  </div>
  <h1>Ramble on Java &amp; Session</h1>
  
  <p>Recently I&rsquo;ve been working on some Java stuff, from JSP, Spring MVC to Hibernate. It&rsquo;s actually not such a smooth and comfortable switch from Python to Java, especially when building a website with frameworks. A hello world page would takes more efforts in Java comparing to Python. Part of the reason may be I&rsquo;m quite a novice in the Java world, the learning curve of which is steeper than that of Python.</p>

<p>However the previous experience on Python web development is not for nothing, to some extent, it helps me understand the concepts in Java web. I always try to find equivalents in Python when coming across a new thing in Java. For example, Tomcat/Jetty, the Java servlet container, is somewhat equivalent to WSGI containers like uWSGI, and servlet, is somewhat equivalent to WSGI. Hibernate is something like Django ORM/Sqlalchemy. Spring AOP is like decorators. Spring Controllers is somewhat like Flask views. Although there&rsquo;s some concepts I can&rsquo;t find analogies to, like dependencies injection, IoC. Python seems to be able to achieve those with the language support.</p>

<p>During my exploration into Java web, I started building a very simple <a href="https://github.com/thoslin/spring-todo">todo list</a> app on Spring MVC, just to get my hands dirty with this famed framework. When working on a simple login function for the app, I came to think how Spring handle sessions. Down below, I use Spring Security for authentication and authorization. Again, I find it is somewhat equivalent to auth/session app in Django.</p>

<p>As I recalled, Django supports couple <a href="https://docs.djangoproject.com/en/1.8/topics/http/sessions/#configuring-the-session-engine">session backends</a>, by default it uses DB to store sessions. When clients first visited, a new session is created in the session table, where all session data for that single session is stored and session keys are returned in cookies. With this session key in cookie, separate requests can share data and relate to each other, as they&rsquo;re in a same session. When clients are authenticated, a flag is set in the session to prevent further authentication.</p>

<p>Apparently this is not how Spring security session works, as they don&rsquo;t have any table created. Another session implementation I remembered is the one from Flask, which uses <a href="http://werkzeug.pocoo.org/docs/0.10/contrib/securecookie/#module-werkzeug.contrib.securecookie">secure cookie</a> from werkzeug. This implementation stores user&rsquo;s session data(no session key in this case) in cookie. Session data is serialized and a checksum of the data is appended before sending back to client. Checksum is checked to make sure data is not tampered. However after inspecting the cookie, there&rsquo;s a only a cookie called JSESSIONID, which should be the id of a session, and skimming through some code of Spring security, this doesn&rsquo;t look like the approach adapted.</p>

<p>So where the hell is session stored in Spring? After some googling around, I learned that A) Session is a low level api implemented in servlet container B) Tomcat stores session in memory! A little bit surprised, session is not persisted. Nevertheless in respect of performance, in memory store is absolute a winner. But the problem is also obvious, What if server crashes? What if there&rsquo;s a cluster of servers? How does it scale?</p>

<p>Then I learned that, to distribute session with a cluster of servers, Tomcat supports <a href="https://tomcat.apache.org/tomcat-6.0-doc/cluster-howto.html">session replication</a>. And there&rsquo;s also a solution called &ldquo;<a href="http://stackoverflow.com/questions/10494431/sticky-and-non-sticky-sessions">sticky session</a>&rdquo;. A term never heard of before. But in fact it is just a load balance strategy that route the same client to the same server so that the client is sticked to that server, the session is kept. However as to the scenario that single server crashed, I&rsquo;m not sure how Tomcat failed over that. Maybe just failed that, session is never meant to store persistent data.</p>

<p>Tracing back to the time when I was working with Django, We tend to use a different session store other than database, such as Memcache or Redis. Rereading the Django documentation on session, I found it also supports <a href="https://docs.djangoproject.com/en/1.8/topics/http/sessions/#using-cached-sessions">local memory</a>, but not recommended. Tomcat also supports different <a href="http://tomcat.apache.org/tomcat-5.5-doc/config/manager.html">persistent storage</a>.</p>

<p>So I&rsquo;ve mumbled so many things about session. That is what really get me started on this post. But what I was trying to convey is that, when switching to different tech stack, surprise is not bad, as we may find that our understanding of things is not that accurate or simply wrong. But just like the analogies I make, the philosophy behind things might be the same. Dig that.</p>

</article>
  <div class="sep">&nbsp;</div>

  
  
  <article>
  <div class="meta">
    <time>02 Jun 2015</time>
  </div>
  <h1>Cassandra: Create a cluster on your local machine</h1>
  
  <p>This post will guide you through how to create a Cassandra cluster of multiple node on a local machine.</p>

<p>First, Let&rsquo;s grab a copy of Cassandra, I&rsquo;m using a Ubuntu 12.04 box and gonna go with Cassandra 1.2.19.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>mkdir test_cluster
</span><span class='line'>cd test_cluster
</span><span class='line'>wget http://www.us.apache.org/dist/cassandra/1.2.19/apache-cassandra-1.2.19-bin.tar.gz
</span><span class='line'>tar xzf apache-cassandra-1.2.19-bin.tar.gz</span></code></pre></td></tr></table></div></figure>


<p>The package already includes everything needed to start a Cassandra node. You can start it by sudo bin/cassandra. It will use all the defaults to start a Cassandra node. With data under /var/lib. with no initial token. We&rsquo;re not going to do that. As we&rsquo;re creating multiple nodes. Each node gonna will have its own directory and configurations. That said,
all nodes will share the same binaries comes within this tarball, but with different confs and directories for logs, data, commit logs.</p>

<p>We will build a directory structure like this:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>node1
</span><span class='line'>├── bin
</span><span class='line'>├── commitlog
</span><span class='line'>├── conf
</span><span class='line'>├── data
</span><span class='line'>├── logs
</span><span class='line'>└── saved_caches</span></code></pre></td></tr></table></div></figure>


<p>Now let&rsquo;s set up our first node:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>cd test_cluster
</span><span class='line'>mkdir node1
</span><span class='line'>cd node1
</span><span class='line'>mkdir commitlog data logs save_caches
</span><span class='line'>cp -r ../apache-cassandra-1.2.19/bin .
</span><span class='line'>cp -r ../apache-cassandra-1.2.19/conf .</span></code></pre></td></tr></table></div></figure>


<p>We need to make some customizations before we bootstrap this node. And before we jump into that, we should generate initial_token for each node, unless you prefer virtual node, which is recommended. Anyway I use the following command to generate tokens:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>python -c 'print [str(((2**64 / number_of_tokens) * i) - 2**63) for i in range(number_of_tokens)]'</span></code></pre></td></tr></table></div></figure>


<p>We&rsquo;re going to create two nodes:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>python -c 'print [str(((2**64 / 2) * i) - 2**63) for i in range(2)]'  
</span><span class='line'>['-9223372036854775808', '0']</span></code></pre></td></tr></table></div></figure>


<p>Now we can proceed with the setup:</p>

<h4>conf/cassandra.yaml</h4>

<p>The configuration file for Cassandra. There are couple items needs to be changed:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>commitlog_directory: /home/tom/test_cluster/node1/commitlog
</span><span class='line'>data_file_directories:
</span><span class='line'>- /home/tom/test_cluster/node1/data
</span><span class='line'>initial_token: -9223372036854775808
</span><span class='line'>listen_address: 127.0.0.1
</span><span class='line'>rpc_address: 127.0.0.1
</span><span class='line'>saved_caches_directory: /home/tom/test_cluster/node1/saved_caches</span></code></pre></td></tr></table></div></figure>


<h4>bin/cassandra.in.sh</h4>

<p>The so-called include script. For seting environment variables needed by the start script bin/cassandra. We&rsquo;ll change following:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>CASSANDRA_HOME=/home/tom/test_cluster/apache-cassandra-1.2.19
</span><span class='line'>CASSANDRA_CONF=/home/tom/test_cluster/node1/conf</span></code></pre></td></tr></table></div></figure>


<p>CASSANDRA_HOME is where the binaries live, CASSANDRA_CONF is where the conf for the node lives.</p>

<h4>conf/log4j-server.properies</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>log4j.appender.R.File=/home/tom/test_cluster/node1/logs/system.log</span></code></pre></td></tr></table></div></figure>


<p>Now we&rsquo;re all set to start the node. Remember to set the CASSANDRA_INCLUDE to our cassandra.in.sh so that Cassandra will search the right place for confs.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>CASSANDRA_INCLUDE=/home/tom/test_cluster/node1/bin/cassandra.in.sh /home/tom/test_cluster/node1/bin/cassandra -f</span></code></pre></td></tr></table></div></figure>


<p>OK. If everything goes soothly, you should have the node up and running. Now Let&rsquo;s set up a second node. Nothing special. Just repeat the above steps. Use &ldquo;node2&rdquo; instead of &ldquo;node1&rdquo; when changing configurations. And use a different listen_address and rpc_address:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>commitlog_directory: /home/tom/test_cluster/node2/commitlog
</span><span class='line'>data_file_directories:
</span><span class='line'>- /home/tom/test_cluster/node2/data
</span><span class='line'>initial_token: 0
</span><span class='line'>listen_address: 127.0.0.2
</span><span class='line'>rpc_address: 127.0.0.2
</span><span class='line'>saved_caches_directory: /home/tom/test_cluster/node2/saved_caches</span></code></pre></td></tr></table></div></figure>


<p>And remember to make an extra modification to <strong>conf/cassandra-env.sh</strong> to avoid port conflicts. Change default JMX_PORT to anything other than default 7199.
And start the node. The node will automatically join the ring.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>~/test_cluster/node1 » bin/nodetool ring
</span><span class='line'>Note: Ownership information does not include topology; for complete information, specify a keyspace
</span><span class='line'>Datacenter: datacenter1
</span><span class='line'>==========
</span><span class='line'>Address    Rack        Status State   Load            Owns                Token                                      
</span><span class='line'>                                                                          0                                          
</span><span class='line'>127.0.0.1  rack1       Up     Normal  13.99 KB        50.00%              -9223372036854775808                      
</span><span class='line'>127.0.0.2  rack1       Up     Normal  10.71 KB        50.00%              0              </span></code></pre></td></tr></table></div></figure>


<p>Alright. You got a cluster running on your local machine!</p>

<p>Reference:
<a href="http://wiki.apache.org/cassandra/GettingStarted">http://wiki.apache.org/cassandra/GettingStarted</a></p>

</article>
  <div class="sep">&nbsp;</div>

  
  
  <article>
  <div class="meta">
    <time>12 May 2014</time>
  </div>
  <h1>Simple Guide to Install StatsD and Graphite</h1>
  
  <p>I&rsquo;ve been playing around with <a href="https://github.com/etsy/statsd">StatD</a> and <a href="">Graphite</a> lately. It took me quite a while to set this stack up. So I think it worthwhile to write a post to walk through the whole installing and configuring process for future reference.</p>

<p>Here is a checklist of all the softwares I&rsquo;m gonna use:</p>

<ul>
<li>StatD</li>
<li>Graphite</li>
<li><a href="http://grafana.org/">Grafana</a></li>
<li><a href="http://gunicorn.org/">Gunicorn</a></li>
<li>Nginx</li>
<li><a href="http://supervisord.org/">Supervisor</a></li>
</ul>


<p>I&rsquo;m setting up all these stuff inside a Ubuntu precise32 <a href="http://files.vagrantup.com/precise32.box">Vagrant box</a>. If you are also using a Vagrant box, add these settings in your Vagrant file.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'> <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">network</span> <span class="ss">:forwarded_port</span><span class="p">,</span> <span class="ss">guest</span><span class="p">:</span> <span class="mi">80</span><span class="p">,</span> <span class="ss">host</span><span class="p">:</span> <span class="mi">8080</span>
</span><span class='line'> <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">network</span> <span class="ss">:forwarded_port</span><span class="p">,</span> <span class="ss">guest</span><span class="p">:</span> <span class="mi">8125</span><span class="p">,</span> <span class="ss">host</span><span class="p">:</span> <span class="mi">8125</span><span class="p">,</span> <span class="ss">protocol</span><span class="p">:</span> <span class="s1">&#39;udp&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Let&rsquo;s ssh into vagrant and change to root first</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'> vagrant ssh
</span><span class='line'> sudo su -
</span></code></pre></td></tr></table></div></figure>


<h3>Install Graphite</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'> apt-get install git python-virtualenv python-dev
</span><span class='line'> virtualenv /opt/graphite
</span><span class='line'> <span class="nb">source</span> /opt/graphite/bin/activate
</span><span class='line'> pip install https://github.com/graphite-project/ceres/tarball/master
</span><span class='line'> pip install whisper
</span><span class='line'> pip install carbon
</span></code></pre></td></tr></table></div></figure>


<h3>Install Graphite Web</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'> apt-get install libcairo2-dev
</span><span class='line'> <span class="nb">cd</span> /opt/graphite
</span><span class='line'> git clone https://github.com/graphite-project/graphite-web.git
</span><span class='line'> <span class="nb">cd </span>graphite-web
</span><span class='line'> git checkout 0.9.12
</span><span class='line'> python setup.py install
</span><span class='line'> pip install -r requirements.txt
</span><span class='line'> django-admin.py syncdb --settings<span class="o">=</span>graphite.settings --pythonpath<span class="o">=</span>/opt/graphite/webapp
</span></code></pre></td></tr></table></div></figure>


<p>Graphite includes a wsgi file in its installation. Just copy it for later deployment</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'> cp /opt/graphite/conf/graphite.wsgi.example /opt/graphite/webapp/wsgi.py
</span></code></pre></td></tr></table></div></figure>


<h3>Configure Carbon</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'> <span class="nb">cd</span> /opt/graphite/conf/
</span><span class='line'> cp carbon.conf.example carbon.conf
</span><span class='line'> cat &gt; storage-schemas.conf <span class="s">&lt;&lt; EOF</span>
</span><span class='line'><span class="s">[stats]</span>
</span><span class='line'><span class="s">pattern = ^stats.*</span>
</span><span class='line'><span class="s">retentions = 10s:6h,1min:6d,10min:1800d</span>
</span><span class='line'><span class="s">EOF</span>
</span></code></pre></td></tr></table></div></figure>


<p>The storage schema is copied from <a href="https://github.com/etsy/statsd/blob/master/docs/graphite.md#storage-schemas">StatsD</a>. Tweak it to meet your needs.</p>

<h3>Install statsd</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'> apt-get install nodejs
</span><span class='line'> <span class="nb">cd</span> /opt/
</span><span class='line'> git clone https://github.com/etsy/statsd.git
</span><span class='line'> cat &gt; statsd/config.js <span class="s">&lt;&lt; EOF</span>
</span><span class='line'><span class="s">{</span>
</span><span class='line'><span class="s">  graphitePort: 2003</span>
</span><span class='line'><span class="s">, graphiteHost: &quot;127.0.0.1&quot;</span>
</span><span class='line'><span class="s">, port: 8125</span>
</span><span class='line'><span class="s">, backends: [ &quot;./backends/graphite&quot; ]</span>
</span><span class='line'><span class="s">, legacyNamespace: false</span>
</span><span class='line'><span class="s">}</span>
</span><span class='line'><span class="s">EOF</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Install Grafana</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'> <span class="nb">cd</span> /opt/
</span><span class='line'> git clone https://github.com/grafana/grafana.git
</span><span class='line'> cp grafana/src/config.sample.js grafana/src/config.js
</span></code></pre></td></tr></table></div></figure>


<h3>Change Permissions</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'> adduser tom
</span><span class='line'> chown tom:tom -R /opt/graphite /opt/statsd /opt/grafana/
</span></code></pre></td></tr></table></div></figure>


<h3>Manage process with Supervisord</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'> apt-get install supervisor
</span><span class='line'> cat &gt; /etc/supervisor/conf.d/gunicorn.conf <span class="s">&lt;&lt; EOF</span>
</span><span class='line'><span class="s">[program:gunicorn]</span>
</span><span class='line'><span class="s">command = /opt/graphite/bin/gunicorn -b 127.0.0.1:8080 -w 2 --pythonpath /opt/graphite/webapp/ wsgi:application</span>
</span><span class='line'><span class="s">directory = /opt/graphite/webapp/</span>
</span><span class='line'><span class="s">user = tom</span>
</span><span class='line'><span class="s">autostart = true</span>
</span><span class='line'><span class="s">autorestart = true</span>
</span><span class='line'><span class="s">redirect_stderr = true</span>
</span><span class='line'><span class="s">EOF</span>
</span><span class='line'> cat &gt; /etc/supervisor/conf.d/statsd.conf <span class="s">&lt;&lt; EOF</span>
</span><span class='line'><span class="s">[program:statsd]</span>
</span><span class='line'><span class="s">command = /usr/bin/node stats.js config.js</span>
</span><span class='line'><span class="s">directory = /opt/statsd/</span>
</span><span class='line'><span class="s">user = tom</span>
</span><span class='line'><span class="s">autostart = true</span>
</span><span class='line'><span class="s">autorestart = true</span>
</span><span class='line'><span class="s">redirect_stderr = true</span>
</span><span class='line'><span class="s">EOF</span>
</span><span class='line'> cat &gt; /etc/supervisor/conf.d/carbon.conf <span class="s">&lt;&lt; EOF</span>
</span><span class='line'><span class="s">[program:carbon]</span>
</span><span class='line'><span class="s">command = /opt/graphite/bin/carbon-cache.py start --debug</span>
</span><span class='line'><span class="s">user = tom</span>
</span><span class='line'><span class="s">autostart = true</span>
</span><span class='line'><span class="s">autorestart = true</span>
</span><span class='line'><span class="s">redirect_stderr = true</span>
</span><span class='line'><span class="s">EOF</span>
</span><span class='line'> supervisorctl reload
</span></code></pre></td></tr></table></div></figure>


<h3>Set up Nginx</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>server <span class="o">{</span>
</span><span class='line'>        listen   80;
</span><span class='line'>
</span><span class='line'>        location / <span class="o">{</span>
</span><span class='line'>                add_header Access-Control-Allow-Origin <span class="s2">&quot;*&quot;</span>;
</span><span class='line'>                proxy_pass http://127.0.0.1:8080;
</span><span class='line'>                proxy_set_header Host <span class="nv">$host</span>;
</span><span class='line'>                proxy_set_header X-Real-IP <span class="nv">$remote_addr</span>;
</span><span class='line'>                proxy_set_header X-Forwarded-For <span class="nv">$proxy_add_x_forwarded_for</span>;
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>        location /grafana/ <span class="o">{</span>
</span><span class='line'>                <span class="nb">alias</span> /opt/grafana/src/;
</span><span class='line'>                index index.html;
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'> apt-get install nginx
</span><span class='line'> ln -s /etc/nginx/sites-available/graphite /etc/nginx/sites-enabled/
</span><span class='line'> rm /etc/nginx/sites-enabled/default
</span><span class='line'> /etc/init.d/nginx restart
</span></code></pre></td></tr></table></div></figure>


<p>Now go to <a href="http://127.0.0.1:8080/">http://127.0.0.1:8080/</a> for Graphite and <a href="http://127.0.0.1:8080/grafana/">http://127.0.0.1:8080/grafana/</a> for Grafana.</p>

</article>
  <div class="sep">&nbsp;</div>

<div id="full-archive">
    <a href="/archive/">View the full archive &rarr;</a>
</div>
    </section>
    <script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-42896888-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>
  </body>
</html>